# DriftMgr CLI Usage Guide

Complete guide for using the DriftMgr command-line interface.

## Table of Contents
- [Installation](#installation)
- [Basic Commands](#basic-commands)
- [Discovery Commands](#discovery-commands)
- [Drift Detection](#drift-detection)
- [State Management](#state-management)
- [Remediation](#remediation)
- [Monitoring](#monitoring)
- [Configuration](#configuration)
- [Advanced Usage](#advanced-usage)
- [Examples](#examples)

## Installation

### Binary Installation
```bash
# Download latest release
curl -L https://github.com/catherinevee/driftmgr/releases/latest/download/driftmgr-linux-amd64.tar.gz | tar xz
chmod +x driftmgr
sudo mv driftmgr /usr/local/bin/

# Verify installation
driftmgr --version
```

### Docker Installation
```bash
# Pull latest image
docker pull catherinevee/driftmgr:latest

# Run as container
docker run --rm -it \
  -v ~/.aws:/root/.aws:ro \
  catherinevee/driftmgr discover --provider aws
```

### From Source
```bash
git clone https://github.com/catherinevee/driftmgr.git
cd driftmgr
make install
```

## Basic Commands

### Global Flags
```bash
driftmgr [command] [flags]

Global Flags:
  --config string      Config file (default: $HOME/.driftmgr/config.yaml)
  --log-level string   Log level: debug, info, warn, error (default: info)
  --output string      Output format: json, yaml, table, csv (default: table)
  --no-color          Disable colored output
  --quiet             Suppress non-essential output
  --verbose           Enable verbose output
  --help              Show help for command
  --version           Show version information
```

### Common Commands
```bash
# Show help
driftmgr help
driftmgr [command] --help

# Show version
driftmgr version

# Check status
driftmgr status

# List available providers
driftmgr providers list

# Switch cloud provider/account
driftmgr use [provider]
```

## Discovery Commands

### Basic Discovery
```bash
# Discover all resources in current cloud account
driftmgr discover

# Discover with specific provider
driftmgr discover --provider aws --region us-east-1

# Discover specific resource types
driftmgr discover --types ec2,rds,s3

# Filter by tags
driftmgr discover --tags Environment=production,Team=platform
```

### Advanced Discovery Options
```bash
# Parallel discovery with workers
driftmgr discover --parallel-workers 20

# Incremental discovery (uses cache)
driftmgr discover --incremental --cache-file .driftmgr-cache

# Discovery with timeout
driftmgr discover --timeout 600

# Export results
driftmgr discover --format json > resources.json
driftmgr discover --format csv > resources.csv

# Discovery with filters
driftmgr discover \
  --filter 'state != "terminated"' \
  --filter 'age < 30d' \
  --filter 'cost > 100'
```

### Multi-Account Discovery
```bash
# Discover across all configured accounts
driftmgr discover --all-accounts

# Discover specific accounts
driftmgr discover --accounts prod,staging

# Use specific profile
AWS_PROFILE=production driftmgr discover

# Cross-region discovery
driftmgr discover --regions us-east-1,us-west-2,eu-west-1
```

### Backend Discovery
```bash
# Discover Terraform backends
driftmgr discover backends --path .

# Discover from S3
driftmgr discover backends \
  --backend s3 \
  --bucket terraform-states \
  --prefix env/

# Discover from Azure Storage
driftmgr discover backends \
  --backend azurerm \
  --storage-account tfstates \
  --container prod

# Discover from Terraform Cloud
driftmgr discover backends \
  --backend remote \
  --organization my-org \
  --workspace prod
```

## Drift Detection

### Basic Drift Detection
```bash
# Detect drift from local state file
driftmgr drift detect --state terraform.tfstate

# Detect drift from remote state
driftmgr drift detect \
  --backend s3 \
  --bucket terraform-states \
  --key prod/terraform.tfstate

# Detect with specific sensitivity
driftmgr drift detect --sensitivity high
driftmgr drift detect --sensitivity low
```

### Advanced Drift Detection
```bash
# Ignore certain properties
driftmgr drift detect \
  --ignore-properties last_modified,updated_at \
  --ignore-tags LastScanned,AutoGenerated

# Filter drift by severity
driftmgr drift detect --severity critical,high

# Detect drift for specific resources
driftmgr drift detect \
  --resources vpc-12345,sg-67890 \
  --resource-types aws_instance,aws_security_group

# Compare two states
driftmgr drift compare \
  --state1 old.tfstate \
  --state2 new.tfstate

# Continuous drift detection
driftmgr drift watch \
  --interval 300 \
  --webhook https://hooks.slack.com/...
```

### Drift Reports
```bash
# Generate detailed report
driftmgr drift report \
  --format html \
  --output drift-report.html

# Generate PDF report
driftmgr drift report \
  --format pdf \
  --output drift-report.pdf \
  --include-screenshots

# Generate executive summary
driftmgr drift report \
  --format markdown \
  --executive-summary \
  --output summary.md

# Email report
driftmgr drift report \
  --format html \
  --email ops@company.com \
  --smtp-server smtp.gmail.com
```

## State Management

### State Operations
```bash
# Pull state from remote backend
driftmgr state pull \
  --backend s3 \
  --bucket terraform-states \
  --key prod/terraform.tfstate \
  --output local.tfstate

# Push state to remote backend
driftmgr state push \
  --backend s3 \
  --bucket terraform-states \
  --key prod/terraform.tfstate \
  --input local.tfstate \
  --create-backup

# List states in backend
driftmgr state list \
  --backend s3 \
  --bucket terraform-states

# Show state details
driftmgr state show \
  --state terraform.tfstate \
  --resource aws_instance.web

# Lock state
driftmgr state lock \
  --backend s3 \
  --bucket terraform-states \
  --key prod/terraform.tfstate \
  --lock-id "driftmgr-$(date +%s)"

# Unlock state
driftmgr state unlock \
  --backend s3 \
  --bucket terraform-states \
  --key prod/terraform.tfstate \
  --lock-id "lock-id-here"
```

### State Manipulation
```bash
# Remove resource from state
driftmgr state rm \
  --state terraform.tfstate \
  --resource aws_instance.old \
  --backup

# Move resource in state
driftmgr state mv \
  --state terraform.tfstate \
  --from aws_instance.old \
  --to aws_instance.new

# Import resource into state
driftmgr state import \
  --state terraform.tfstate \
  --resource aws_instance.web \
  --id i-1234567890abcdef0

# Replace provider in state
driftmgr state replace-provider \
  --state terraform.tfstate \
  --from hashicorp/aws \
  --to registry.terraform.io/hashicorp/aws
```

### State Analysis
```bash
# Analyze state for issues
driftmgr state analyze --state terraform.tfstate

# Find orphaned resources
driftmgr state orphans --state terraform.tfstate

# Calculate blast radius
driftmgr state blast-radius \
  --state terraform.tfstate \
  --resource aws_instance.web

# Generate dependency graph
driftmgr state graph \
  --state terraform.tfstate \
  --format dot \
  --output graph.dot

# Visualize state
driftmgr state visualize \
  --state terraform.tfstate \
  --format html \
  --output state-viz.html
```

## Remediation

### Import Generation
```bash
# Generate import commands for unmanaged resources
driftmgr remediate imports \
  --unmanaged-only \
  --output import-commands.sh

# Generate imports with resource mapping
driftmgr remediate imports \
  --map vpc-12345:aws_vpc.main \
  --map sg-67890:aws_security_group.web

# Interactive import
driftmgr remediate imports --interactive
```

### Code Generation
```bash
# Generate Terraform code for discovered resources
driftmgr remediate generate \
  --resources vpc-12345,subnet-67890 \
  --output generated.tf

# Generate with specific provider version
driftmgr remediate generate \
  --provider-version "~> 5.0" \
  --output generated.tf

# Generate HCL from state
driftmgr remediate reverse \
  --state terraform.tfstate \
  --output reversed.tf
```

### Automated Remediation
```bash
# Create remediation plan
driftmgr remediate plan \
  --drift-report drift.json \
  --output remediation-plan.json

# Execute remediation (with approval)
driftmgr remediate apply \
  --plan remediation-plan.json \
  --require-approval

# Rollback remediation
driftmgr remediate rollback \
  --backup backup-20240115.tfstate

# Dry run mode
driftmgr remediate apply \
  --plan remediation-plan.json \
  --dry-run
```

### Deletion Operations
```bash
# Delete unmanaged resources
driftmgr delete unmanaged \
  --confirm \
  --backup

# Bulk delete by filter
driftmgr delete bulk \
  --filter 'tags.Environment == "test"' \
  --filter 'age > 90d' \
  --dry-run

# Delete with dependencies
driftmgr delete resource \
  --id vpc-12345 \
  --cascade \
  --force
```

## Monitoring

### Continuous Monitoring
```bash
# Start monitoring
driftmgr monitor start \
  --interval 300 \
  --config monitoring.yaml

# Stop monitoring
driftmgr monitor stop

# Check monitoring status
driftmgr monitor status

# View monitoring history
driftmgr monitor history --last 24h
```

### Alerts and Notifications
```bash
# Configure Slack webhook
driftmgr monitor webhook add \
  --name slack \
  --url https://hooks.slack.com/services/... \
  --events drift_detected,critical_change

# Configure email alerts
driftmgr monitor email add \
  --smtp-server smtp.gmail.com \
  --smtp-port 587 \
  --from alerts@company.com \
  --to ops@company.com

# Configure PagerDuty
driftmgr monitor pagerduty add \
  --integration-key YOUR_KEY \
  --severity critical
```

### Metrics and Dashboards
```bash
# Export metrics
driftmgr metrics export \
  --format prometheus \
  --output metrics.txt

# Start metrics server
driftmgr serve metrics --port 9090

# Generate dashboard config
driftmgr dashboard generate \
  --type grafana \
  --output dashboard.json
```

## Configuration

### Initialize Configuration
```bash
# Interactive setup
driftmgr init

# Create default config
driftmgr init --default

# Import existing config
driftmgr config import --file old-config.yaml
```

### Manage Configurations
```bash
# Show current config
driftmgr config show

# Set configuration value
driftmgr config set aws.region us-west-2
driftmgr config set discovery.parallel_workers 20

# Get configuration value
driftmgr config get aws.region

# Validate configuration
driftmgr config validate

# Export configuration
driftmgr config export --output config-backup.yaml
```

### Credentials Management
```bash
# Configure AWS credentials
driftmgr credentials add aws \
  --access-key-id YOUR_KEY \
  --secret-access-key YOUR_SECRET \
  --region us-east-1

# Configure Azure credentials
driftmgr credentials add azure \
  --subscription-id YOUR_SUB \
  --tenant-id YOUR_TENANT \
  --client-id YOUR_CLIENT \
  --client-secret YOUR_SECRET

# List credentials
driftmgr credentials list

# Test credentials
driftmgr credentials test aws
driftmgr credentials test azure

# Rotate credentials
driftmgr credentials rotate aws
```

## Advanced Usage

### Policy Enforcement
```bash
# Validate against OPA policy
driftmgr policy validate \
  --policy policies/production.rego \
  --state terraform.tfstate

# Enforce policies during discovery
driftmgr discover \
  --enforce-policy policies/tagging.rego \
  --policy-action block

# Generate policy report
driftmgr policy report \
  --policies policies/*.rego \
  --output policy-report.html
```

### Compliance Checking
```bash
# Run compliance check
driftmgr compliance check \
  --standard soc2 \
  --scope production

# Generate compliance report
driftmgr compliance report \
  --standard hipaa \
  --format pdf \
  --output hipaa-compliance.pdf

# Export evidence
driftmgr compliance evidence \
  --standard pci-dss \
  --control 1.1 \
  --output evidence.zip
```

### Cost Analysis
```bash
# Analyze costs
driftmgr cost analyze \
  --threshold 1000 \
  --group-by service,tag:Environment

# Find cost optimization opportunities
driftmgr cost optimize \
  --savings-threshold 100 \
  --output recommendations.json

# Cost drift detection
driftmgr cost drift \
  --baseline last-month \
  --alert-threshold 20
```

### Workflows
```bash
# Run predefined workflow
driftmgr workflow run daily-check
driftmgr workflow run compliance-audit

# List available workflows
driftmgr workflow list

# Create custom workflow
driftmgr workflow create \
  --name weekly-report \
  --steps discover,drift,report \
  --schedule "0 0 * * 0"

# Execute workflow with parameters
driftmgr workflow run custom \
  --param region=us-west-2 \
  --param severity=critical
```

## Examples

### Daily Operations Workflow
```bash
#!/bin/bash
# Daily drift check script

# 1. Update discovery cache
driftmgr discover --incremental --cache-file .cache

# 2. Check for drift
driftmgr drift detect \
  --backend s3 \
  --bucket terraform-states \
  --key prod/terraform.tfstate \
  --output drift.json

# 3. Generate report if drift found
if [ -s drift.json ]; then
  driftmgr drift report \
    --format html \
    --email team@company.com
fi

# 4. Update metrics
driftmgr metrics export --format prometheus
```

### Multi-Account Scan
```bash
#!/bin/bash
# Scan all AWS accounts

ACCOUNTS=("prod" "staging" "dev")

for account in "${ACCOUNTS[@]}"; do
  echo "Scanning account: $account"
  
  export AWS_PROFILE=$account
  
  driftmgr discover \
    --output ${account}-resources.json
  
  driftmgr drift detect \
    --state s3://terraform-states-${account}/terraform.tfstate \
    --output ${account}-drift.json
done

# Generate consolidated report
driftmgr report consolidate \
  --inputs *-drift.json \
  --output consolidated-report.html
```

### Automated Remediation Pipeline
```bash
#!/bin/bash
# Automated remediation with approval

# 1. Detect drift
DRIFT_FILE=$(mktemp)
driftmgr drift detect --output $DRIFT_FILE

# 2. Check severity
CRITICAL=$(jq '.summary.critical_count' $DRIFT_FILE)

if [ "$CRITICAL" -gt 0 ]; then
  # 3. Generate remediation plan
  PLAN_FILE=$(mktemp)
  driftmgr remediate plan \
    --drift $DRIFT_FILE \
    --output $PLAN_FILE
  
  # 4. Send for approval
  driftmgr remediate request-approval \
    --plan $PLAN_FILE \
    --approvers ops@company.com
  
  # 5. Wait for approval (timeout 1 hour)
  if driftmgr remediate wait-approval --timeout 3600; then
    # 6. Apply remediation
    driftmgr remediate apply \
      --plan $PLAN_FILE \
      --backup
  fi
fi
```

### Compliance Audit
```bash
#!/bin/bash
# Monthly compliance audit

STANDARDS=("soc2" "hipaa" "pci-dss")
DATE=$(date +%Y%m%d)

for standard in "${STANDARDS[@]}"; do
  echo "Checking compliance: $standard"
  
  # Run compliance check
  driftmgr compliance check \
    --standard $standard \
    --output ${standard}-check-${DATE}.json
  
  # Generate report
  driftmgr compliance report \
    --standard $standard \
    --format pdf \
    --output reports/${standard}-${DATE}.pdf
  
  # Export evidence
  driftmgr compliance evidence \
    --standard $standard \
    --output evidence/${standard}-${DATE}.zip
done

# Send summary email
driftmgr compliance summary \
  --reports reports/*-${DATE}.pdf \
  --email compliance@company.com
```

## Shell Completion

### Bash
```bash
# Generate completion script
driftmgr completion bash > /etc/bash_completion.d/driftmgr

# Or source directly
source <(driftmgr completion bash)
```

### Zsh
```bash
# Generate completion script
driftmgr completion zsh > "${fpath[1]}/_driftmgr"

# Or add to .zshrc
echo "source <(driftmgr completion zsh)" >> ~/.zshrc
```

### Fish
```bash
# Generate completion script
driftmgr completion fish > ~/.config/fish/completions/driftmgr.fish
```

### PowerShell
```powershell
# Generate completion script
driftmgr completion powershell > driftmgr.ps1

# Source in profile
Add-Content $PROFILE ". ./driftmgr.ps1"
```

## Environment Variables

```bash
# DriftMgr configuration
export DRIFTMGR_CONFIG=$HOME/.driftmgr/config.yaml
export DRIFTMGR_LOG_LEVEL=debug
export DRIFTMGR_LOG_FILE=/var/log/driftmgr.log
export DRIFTMGR_CACHE_DIR=$HOME/.driftmgr/cache

# Cloud provider credentials
export AWS_PROFILE=production
export AWS_REGION=us-east-1
export AZURE_SUBSCRIPTION_ID=xxx
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/creds.json

# Backend configuration
export TF_STATE_BUCKET=terraform-states
export TF_STATE_KEY=prod/terraform.tfstate
export TF_STATE_REGION=us-east-1

# Performance tuning
export DRIFTMGR_PARALLEL_WORKERS=20
export DRIFTMGR_BATCH_SIZE=100
export DRIFTMGR_TIMEOUT=600

# Feature flags
export DRIFTMGR_EXPERIMENTAL_FEATURES=true
export DRIFTMGR_ENABLE_PROFILING=true
```

## Exit Codes

| Code | Description |
|------|-------------|
| 0    | Success |
| 1    | General error |
| 2    | Configuration error |
| 3    | Authentication error |
| 4    | Resource not found |
| 5    | Drift detected |
| 6    | Policy violation |
| 7    | Timeout |
| 8    | User cancelled |
| 127  | Command not found |

## Troubleshooting

### Enable Debug Mode
```bash
# Verbose logging
driftmgr --log-level debug discover

# Trace AWS API calls
export AWS_SDK_LOG_LEVEL=debug
driftmgr discover --provider aws

# Save debug output
driftmgr --log-level debug discover 2> debug.log
```

### Common Issues
```bash
# Reset cache
rm -rf ~/.driftmgr/cache
driftmgr discover --no-cache

# Fix permission issues
chmod 600 ~/.driftmgr/config.yaml
chmod 700 ~/.driftmgr

# Validate credentials
driftmgr credentials test --all

# Check connectivity
driftmgr diagnose connectivity
driftmgr diagnose permissions
```

## Getting Help

```bash
# Show help for any command
driftmgr help [command]
driftmgr [command] --help

# Show examples
driftmgr examples [command]

# Open documentation
driftmgr docs

# Report issues
driftmgr bug-report

# Join community
driftmgr community
```